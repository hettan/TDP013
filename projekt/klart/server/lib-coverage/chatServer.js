/* automatically generated by JSCoverage - do not edit */
try {
  if (typeof top === 'object' && top !== null && typeof top.opener === 'object' && top.opener !== null) {
    // this is a browser window that was opened from another window

    if (! top.opener._$jscoverage) {
      top.opener._$jscoverage = {};
    }
  }
}
catch (e) {}

try {
  if (typeof top === 'object' && top !== null) {
    // this is a browser window

    try {
      if (typeof top.opener === 'object' && top.opener !== null && top.opener._$jscoverage) {
        top._$jscoverage = top.opener._$jscoverage;
      }
    }
    catch (e) {}

    if (! top._$jscoverage) {
      top._$jscoverage = {};
    }
  }
}
catch (e) {}

try {
  if (typeof top === 'object' && top !== null && top._$jscoverage) {
    _$jscoverage = top._$jscoverage;
  }
}
catch (e) {}
if (typeof _$jscoverage !== 'object') {
  _$jscoverage = {};
}
if (! _$jscoverage['chatServer.js']) {
  _$jscoverage['chatServer.js'] = [];
  _$jscoverage['chatServer.js'][2] = 0;
  _$jscoverage['chatServer.js'][4] = 0;
  _$jscoverage['chatServer.js'][5] = 0;
  _$jscoverage['chatServer.js'][7] = 0;
  _$jscoverage['chatServer.js'][8] = 0;
  _$jscoverage['chatServer.js'][11] = 0;
  _$jscoverage['chatServer.js'][12] = 0;
  _$jscoverage['chatServer.js'][16] = 0;
  _$jscoverage['chatServer.js'][17] = 0;
  _$jscoverage['chatServer.js'][18] = 0;
  _$jscoverage['chatServer.js'][19] = 0;
  _$jscoverage['chatServer.js'][20] = 0;
  _$jscoverage['chatServer.js'][21] = 0;
  _$jscoverage['chatServer.js'][24] = 0;
  _$jscoverage['chatServer.js'][25] = 0;
  _$jscoverage['chatServer.js'][26] = 0;
  _$jscoverage['chatServer.js'][27] = 0;
  _$jscoverage['chatServer.js'][30] = 0;
  _$jscoverage['chatServer.js'][33] = 0;
  _$jscoverage['chatServer.js'][34] = 0;
  _$jscoverage['chatServer.js'][35] = 0;
  _$jscoverage['chatServer.js'][36] = 0;
  _$jscoverage['chatServer.js'][37] = 0;
  _$jscoverage['chatServer.js'][40] = 0;
  _$jscoverage['chatServer.js'][41] = 0;
  _$jscoverage['chatServer.js'][42] = 0;
  _$jscoverage['chatServer.js'][43] = 0;
  _$jscoverage['chatServer.js'][46] = 0;
  _$jscoverage['chatServer.js'][50] = 0;
  _$jscoverage['chatServer.js'][51] = 0;
  _$jscoverage['chatServer.js'][52] = 0;
  _$jscoverage['chatServer.js'][53] = 0;
  _$jscoverage['chatServer.js'][54] = 0;
  _$jscoverage['chatServer.js'][55] = 0;
  _$jscoverage['chatServer.js'][56] = 0;
  _$jscoverage['chatServer.js'][57] = 0;
  _$jscoverage['chatServer.js'][58] = 0;
  _$jscoverage['chatServer.js'][63] = 0;
  _$jscoverage['chatServer.js'][67] = 0;
  _$jscoverage['chatServer.js'][69] = 0;
  _$jscoverage['chatServer.js'][70] = 0;
  _$jscoverage['chatServer.js'][75] = 0;
  _$jscoverage['chatServer.js'][76] = 0;
  _$jscoverage['chatServer.js'][78] = 0;
  _$jscoverage['chatServer.js'][79] = 0;
  _$jscoverage['chatServer.js'][81] = 0;
  _$jscoverage['chatServer.js'][82] = 0;
  _$jscoverage['chatServer.js'][83] = 0;
  _$jscoverage['chatServer.js'][85] = 0;
  _$jscoverage['chatServer.js'][86] = 0;
  _$jscoverage['chatServer.js'][87] = 0;
  _$jscoverage['chatServer.js'][89] = 0;
  _$jscoverage['chatServer.js'][90] = 0;
  _$jscoverage['chatServer.js'][91] = 0;
  _$jscoverage['chatServer.js'][92] = 0;
  _$jscoverage['chatServer.js'][95] = 0;
  _$jscoverage['chatServer.js'][98] = 0;
  _$jscoverage['chatServer.js'][99] = 0;
  _$jscoverage['chatServer.js'][100] = 0;
  _$jscoverage['chatServer.js'][101] = 0;
  _$jscoverage['chatServer.js'][102] = 0;
  _$jscoverage['chatServer.js'][103] = 0;
  _$jscoverage['chatServer.js'][108] = 0;
  _$jscoverage['chatServer.js'][110] = 0;
  _$jscoverage['chatServer.js'][116] = 0;
  _$jscoverage['chatServer.js'][118] = 0;
  _$jscoverage['chatServer.js'][125] = 0;
  _$jscoverage['chatServer.js'][134] = 0;
  _$jscoverage['chatServer.js'][141] = 0;
  _$jscoverage['chatServer.js'][142] = 0;
  _$jscoverage['chatServer.js'][143] = 0;
  _$jscoverage['chatServer.js'][144] = 0;
  _$jscoverage['chatServer.js'][150] = 0;
  _$jscoverage['chatServer.js'][151] = 0;
  _$jscoverage['chatServer.js'][152] = 0;
  _$jscoverage['chatServer.js'][154] = 0;
  _$jscoverage['chatServer.js'][155] = 0;
  _$jscoverage['chatServer.js'][163] = 0;
  _$jscoverage['chatServer.js'][164] = 0;
  _$jscoverage['chatServer.js'][167] = 0;
  _$jscoverage['chatServer.js'][168] = 0;
}
_$jscoverage['chatServer.js'].source = ["// websocket and http servers","var webSocketServer = require('websocket').server;","","var clients = []; //Connected clients","var groups = {};","","var userIndex = 0;","var groupCount = 0;","","//Formats the string for html usage","function htmlEntities(str) {","    return String(str).replace(/&amp;/g, '&amp;amp;').replace(/&lt;/g, '&amp;lt;')","        .replace(/&gt;/g, '&amp;gt;').replace(/\"/g, '&amp;quot;');","}","","function createGroup(userIndex) {","    var newGroup = new Array();","    newGroup[0] = userIndex;","    groupCount++;","    groups[groupCount] = newGroup;","    return groupCount;","}","","function inGroup(groupID, userIndex) {","    for(var i=0; i &lt; groups[groupID].length; i++) {","        if (groups[groupID][i] == userIndex) {","            return true;","        }","    }","    return false;","}","        ","function addToGroup(groupID, user) {","    for(var i=0; i &lt; clients.length; i++) {","        if (clients[i][\"user\"] == user) {","            if (inGroup(groupID,i)) {","                return false;","            }","                ","            delete groups[clients[i][\"group\"]];","            groups[groupID].push(i);","            clients[i][\"group\"] = groupID;","            return true;","        }","    }","    return false;","}","","//Working most of the times but not implemented on client","function removeFromGroup(groupID, user) {","    console.log(\"rem callled - for group=\" + groupID + \"   user=\"+user);","    for(var i=0; i &lt; clients.length; i++) {","        if (clients[i][\"user\"] == user) {","            for (var x=0; x &lt; groups[groupID].length; x++) {","                if (groups[groupID][x] == i) {","                    groups[groupID].splice(x,1);","                    clients[i][\"group\"] = createGroup(i);","                    return true;","                }","            }","        }","    }","    return false;","}","","//Will be set from main.js","var onDisconnect = function() {};","","function start(server) {","    var wsServer = new webSocketServer({","        httpServer: server","    });","","    //Incomming connection","    wsServer.on('request', function(request) {","        console.log('Connection from ' + request.origin);","        ","        var connection = request.accept(null, request.origin);","        console.log('Connection accepted.');","        ","        var userName;","        var index = clients.push({\"user\": userName,\"conn\": connection, \"group\": -1}) - 1;","        clients[index][\"group\"] = createGroup(index);","        ","        var userSet = false;","        connection.on('message', function(message) {","            var msg = message.utf8Data;","            ","            if (!userSet) {","                userName = msg;","                clients[index][\"user\"] = userName;","                userSet = true;","            }","            else {","                console.log(' Received Message from '","                            + userName + ': ' + msg);","","                var obj;","                if (msg.substr(0,5) == \"/inv \" || msg.substr(0,5) == \"/rem \") {","                    var targetUser = msg.substr(5,msg.length -1);","                    console.log(msg);","                    if (targetUser == userName) {","                        obj = {","                            text: htmlEntities(\"Cant use that on yourself!\"),","                            name: \"server\"","                        };","                    }","                    else if (msg.substr(0,5) == \"/inv \" &amp;&amp;","                             addToGroup(clients[index][\"group\"], targetUser)) {","                        obj = {","                            text: htmlEntities(targetUser + \" has joined the conversation\"),","                            name: \"server\"","                        };","                        ","                    }","                    else if (msg.substr(0,5) == \"/rem \" &amp;&amp;","                             removeFromGroup(clients[index][\"group\"], targetUser)) {","                        obj = {","                            text: htmlEntities(targetUser + \" has been removed from the conversation\"),","                            name: \"server\"","                        };","                        ","                    }","                    else {","                        obj = {","                            text: htmlEntities(targetUser + \" could not be found or is already in the conversation!\"),","                            name: \"server\"","                        };","                    }","                    ","                }","                else {","                    ","                    obj = {","                        text: htmlEntities(msg),","                        name: userName","                    };           ","                }","                ","                // broadcast message to all clients in group","                var group = groups[clients[index][\"group\"]];","                var json = JSON.stringify(obj);","                for (var i=0; i &lt; group.length; i++) {","                    clients[group[i]][\"conn\"].sendUTF(json);","                }","            }","        });","","        // user disconnected","        connection.on('close', function(connection) {","            if (userName !== false) {","                console.log(\"User disconnected.\");","                // remove user from the list of connected clients","                onDisconnect(clients[index][\"user\"]);","                delete clients[index];","            }","        });","","    });","}","","//set user as inactive in db","function setInactive(callback) {","    onDisconnect = callback;","}","","exports.setInactive = setInactive;","exports.start = start;"];
_$jscoverage['chatServer.js'][2]++;
var webSocketServer = require("websocket").server;
_$jscoverage['chatServer.js'][4]++;
var clients = [];
_$jscoverage['chatServer.js'][5]++;
var groups = {};
_$jscoverage['chatServer.js'][7]++;
var userIndex = 0;
_$jscoverage['chatServer.js'][8]++;
var groupCount = 0;
_$jscoverage['chatServer.js'][11]++;
function htmlEntities(str) {
  _$jscoverage['chatServer.js'][12]++;
  return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}
_$jscoverage['chatServer.js'][16]++;
function createGroup(userIndex) {
  _$jscoverage['chatServer.js'][17]++;
  var newGroup = new Array();
  _$jscoverage['chatServer.js'][18]++;
  newGroup[0] = userIndex;
  _$jscoverage['chatServer.js'][19]++;
  (groupCount++);
  _$jscoverage['chatServer.js'][20]++;
  groups[groupCount] = newGroup;
  _$jscoverage['chatServer.js'][21]++;
  return groupCount;
}
_$jscoverage['chatServer.js'][24]++;
function inGroup(groupID, userIndex) {
  _$jscoverage['chatServer.js'][25]++;
  for (var i = 0; (i < groups[groupID].length); (i++)) {
    _$jscoverage['chatServer.js'][26]++;
    if ((groups[groupID][i] == userIndex)) {
      _$jscoverage['chatServer.js'][27]++;
      return true;
    }
}
  _$jscoverage['chatServer.js'][30]++;
  return false;
}
_$jscoverage['chatServer.js'][33]++;
function addToGroup(groupID, user) {
  _$jscoverage['chatServer.js'][34]++;
  for (var i = 0; (i < clients.length); (i++)) {
    _$jscoverage['chatServer.js'][35]++;
    if ((clients[i].user == user)) {
      _$jscoverage['chatServer.js'][36]++;
      if (inGroup(groupID, i)) {
        _$jscoverage['chatServer.js'][37]++;
        return false;
      }
      _$jscoverage['chatServer.js'][40]++;
      (delete groups[clients[i].group]);
      _$jscoverage['chatServer.js'][41]++;
      groups[groupID].push(i);
      _$jscoverage['chatServer.js'][42]++;
      clients[i].group = groupID;
      _$jscoverage['chatServer.js'][43]++;
      return true;
    }
}
  _$jscoverage['chatServer.js'][46]++;
  return false;
}
_$jscoverage['chatServer.js'][50]++;
function removeFromGroup(groupID, user) {
  _$jscoverage['chatServer.js'][51]++;
  console.log(("rem callled - for group=" + groupID + "   user=" + user));
  _$jscoverage['chatServer.js'][52]++;
  for (var i = 0; (i < clients.length); (i++)) {
    _$jscoverage['chatServer.js'][53]++;
    if ((clients[i].user == user)) {
      _$jscoverage['chatServer.js'][54]++;
      for (var x = 0; (x < groups[groupID].length); (x++)) {
        _$jscoverage['chatServer.js'][55]++;
        if ((groups[groupID][x] == i)) {
          _$jscoverage['chatServer.js'][56]++;
          groups[groupID].splice(x, 1);
          _$jscoverage['chatServer.js'][57]++;
          clients[i].group = createGroup(i);
          _$jscoverage['chatServer.js'][58]++;
          return true;
        }
}
    }
}
  _$jscoverage['chatServer.js'][63]++;
  return false;
}
_$jscoverage['chatServer.js'][67]++;
var onDisconnect = (function () {
});
_$jscoverage['chatServer.js'][69]++;
function start(server) {
  _$jscoverage['chatServer.js'][70]++;
  var wsServer = new webSocketServer({httpServer: server});
  _$jscoverage['chatServer.js'][75]++;
  wsServer.on("request", (function (request) {
  _$jscoverage['chatServer.js'][76]++;
  console.log(("Connection from " + request.origin));
  _$jscoverage['chatServer.js'][78]++;
  var connection = request.accept(null, request.origin);
  _$jscoverage['chatServer.js'][79]++;
  console.log("Connection accepted.");
  _$jscoverage['chatServer.js'][81]++;
  var userName;
  _$jscoverage['chatServer.js'][82]++;
  var index = (clients.push({"user": userName, "conn": connection, "group": -1}) - 1);
  _$jscoverage['chatServer.js'][83]++;
  clients[index].group = createGroup(index);
  _$jscoverage['chatServer.js'][85]++;
  var userSet = false;
  _$jscoverage['chatServer.js'][86]++;
  connection.on("message", (function (message) {
  _$jscoverage['chatServer.js'][87]++;
  var msg = message.utf8Data;
  _$jscoverage['chatServer.js'][89]++;
  if ((! userSet)) {
    _$jscoverage['chatServer.js'][90]++;
    userName = msg;
    _$jscoverage['chatServer.js'][91]++;
    clients[index].user = userName;
    _$jscoverage['chatServer.js'][92]++;
    userSet = true;
  }
  else {
    _$jscoverage['chatServer.js'][95]++;
    console.log((" Received Message from " + userName + ": " + msg));
    _$jscoverage['chatServer.js'][98]++;
    var obj;
    _$jscoverage['chatServer.js'][99]++;
    if (((msg.substr(0, 5) == "/inv ") || (msg.substr(0, 5) == "/rem "))) {
      _$jscoverage['chatServer.js'][100]++;
      var targetUser = msg.substr(5, (msg.length - 1));
      _$jscoverage['chatServer.js'][101]++;
      console.log(msg);
      _$jscoverage['chatServer.js'][102]++;
      if ((targetUser == userName)) {
        _$jscoverage['chatServer.js'][103]++;
        obj = {text: htmlEntities("Cant use that on yourself!"), name: "server"};
      }
      else {
        _$jscoverage['chatServer.js'][108]++;
        if (((msg.substr(0, 5) == "/inv ") && addToGroup(clients[index].group, targetUser))) {
          _$jscoverage['chatServer.js'][110]++;
          obj = {text: htmlEntities((targetUser + " has joined the conversation")), name: "server"};
        }
        else {
          _$jscoverage['chatServer.js'][116]++;
          if (((msg.substr(0, 5) == "/rem ") && removeFromGroup(clients[index].group, targetUser))) {
            _$jscoverage['chatServer.js'][118]++;
            obj = {text: htmlEntities((targetUser + " has been removed from the conversation")), name: "server"};
          }
          else {
            _$jscoverage['chatServer.js'][125]++;
            obj = {text: htmlEntities((targetUser + " could not be found or is already in the conversation!")), name: "server"};
          }
        }
      }
    }
    else {
      _$jscoverage['chatServer.js'][134]++;
      obj = {text: htmlEntities(msg), name: userName};
    }
    _$jscoverage['chatServer.js'][141]++;
    var group = groups[clients[index].group];
    _$jscoverage['chatServer.js'][142]++;
    var json = JSON.stringify(obj);
    _$jscoverage['chatServer.js'][143]++;
    for (var i = 0; (i < group.length); (i++)) {
      _$jscoverage['chatServer.js'][144]++;
      clients[group[i]].conn.sendUTF(json);
}
  }
}));
  _$jscoverage['chatServer.js'][150]++;
  connection.on("close", (function (connection) {
  _$jscoverage['chatServer.js'][151]++;
  if ((userName !== false)) {
    _$jscoverage['chatServer.js'][152]++;
    console.log("User disconnected.");
    _$jscoverage['chatServer.js'][154]++;
    onDisconnect(clients[index].user);
    _$jscoverage['chatServer.js'][155]++;
    (delete clients[index]);
  }
}));
}));
}
_$jscoverage['chatServer.js'][163]++;
function setInactive(callback) {
  _$jscoverage['chatServer.js'][164]++;
  onDisconnect = callback;
}
_$jscoverage['chatServer.js'][167]++;
exports.setInactive = setInactive;
_$jscoverage['chatServer.js'][168]++;
exports.start = start;
