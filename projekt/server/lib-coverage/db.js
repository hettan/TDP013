/* automatically generated by JSCoverage - do not edit */
try {
  if (typeof top === 'object' && top !== null && typeof top.opener === 'object' && top.opener !== null) {
    // this is a browser window that was opened from another window

    if (! top.opener._$jscoverage) {
      top.opener._$jscoverage = {};
    }
  }
}
catch (e) {}

try {
  if (typeof top === 'object' && top !== null) {
    // this is a browser window

    try {
      if (typeof top.opener === 'object' && top.opener !== null && top.opener._$jscoverage) {
        top._$jscoverage = top.opener._$jscoverage;
      }
    }
    catch (e) {}

    if (! top._$jscoverage) {
      top._$jscoverage = {};
    }
  }
}
catch (e) {}

try {
  if (typeof top === 'object' && top !== null && top._$jscoverage) {
    _$jscoverage = top._$jscoverage;
  }
}
catch (e) {}
if (typeof _$jscoverage !== 'object') {
  _$jscoverage = {};
}
if (! _$jscoverage['db.js']) {
  _$jscoverage['db.js'] = [];
  _$jscoverage['db.js'][1] = 0;
  _$jscoverage['db.js'][3] = 0;
  _$jscoverage['db.js'][4] = 0;
  _$jscoverage['db.js'][6] = 0;
  _$jscoverage['db.js'][8] = 0;
  _$jscoverage['db.js'][9] = 0;
  _$jscoverage['db.js'][10] = 0;
  _$jscoverage['db.js'][11] = 0;
  _$jscoverage['db.js'][12] = 0;
  _$jscoverage['db.js'][15] = 0;
  _$jscoverage['db.js'][20] = 0;
  _$jscoverage['db.js'][21] = 0;
  _$jscoverage['db.js'][22] = 0;
  _$jscoverage['db.js'][23] = 0;
  _$jscoverage['db.js'][24] = 0;
  _$jscoverage['db.js'][31] = 0;
  _$jscoverage['db.js'][32] = 0;
  _$jscoverage['db.js'][36] = 0;
  _$jscoverage['db.js'][43] = 0;
  _$jscoverage['db.js'][44] = 0;
  _$jscoverage['db.js'][45] = 0;
  _$jscoverage['db.js'][46] = 0;
  _$jscoverage['db.js'][47] = 0;
  _$jscoverage['db.js'][48] = 0;
  _$jscoverage['db.js'][49] = 0;
  _$jscoverage['db.js'][52] = 0;
  _$jscoverage['db.js'][57] = 0;
  _$jscoverage['db.js'][62] = 0;
  _$jscoverage['db.js'][63] = 0;
  _$jscoverage['db.js'][64] = 0;
  _$jscoverage['db.js'][65] = 0;
  _$jscoverage['db.js'][66] = 0;
  _$jscoverage['db.js'][67] = 0;
  _$jscoverage['db.js'][71] = 0;
  _$jscoverage['db.js'][77] = 0;
  _$jscoverage['db.js'][78] = 0;
  _$jscoverage['db.js'][79] = 0;
  _$jscoverage['db.js'][80] = 0;
  _$jscoverage['db.js'][81] = 0;
  _$jscoverage['db.js'][82] = 0;
  _$jscoverage['db.js'][83] = 0;
  _$jscoverage['db.js'][84] = 0;
  _$jscoverage['db.js'][86] = 0;
  _$jscoverage['db.js'][88] = 0;
  _$jscoverage['db.js'][91] = 0;
  _$jscoverage['db.js'][95] = 0;
  _$jscoverage['db.js'][101] = 0;
  _$jscoverage['db.js'][102] = 0;
  _$jscoverage['db.js'][103] = 0;
  _$jscoverage['db.js'][104] = 0;
  _$jscoverage['db.js'][105] = 0;
  _$jscoverage['db.js'][106] = 0;
  _$jscoverage['db.js'][107] = 0;
  _$jscoverage['db.js'][108] = 0;
  _$jscoverage['db.js'][109] = 0;
  _$jscoverage['db.js'][113] = 0;
  _$jscoverage['db.js'][118] = 0;
  _$jscoverage['db.js'][119] = 0;
  _$jscoverage['db.js'][120] = 0;
  _$jscoverage['db.js'][122] = 0;
  _$jscoverage['db.js'][125] = 0;
  _$jscoverage['db.js'][129] = 0;
  _$jscoverage['db.js'][130] = 0;
  _$jscoverage['db.js'][131] = 0;
  _$jscoverage['db.js'][132] = 0;
  _$jscoverage['db.js'][133] = 0;
  _$jscoverage['db.js'][134] = 0;
  _$jscoverage['db.js'][135] = 0;
  _$jscoverage['db.js'][136] = 0;
  _$jscoverage['db.js'][137] = 0;
  _$jscoverage['db.js'][145] = 0;
  _$jscoverage['db.js'][146] = 0;
  _$jscoverage['db.js'][147] = 0;
  _$jscoverage['db.js'][148] = 0;
  _$jscoverage['db.js'][149] = 0;
  _$jscoverage['db.js'][150] = 0;
  _$jscoverage['db.js'][151] = 0;
  _$jscoverage['db.js'][152] = 0;
  _$jscoverage['db.js'][153] = 0;
  _$jscoverage['db.js'][154] = 0;
  _$jscoverage['db.js'][155] = 0;
  _$jscoverage['db.js'][157] = 0;
  _$jscoverage['db.js'][158] = 0;
  _$jscoverage['db.js'][166] = 0;
  _$jscoverage['db.js'][167] = 0;
  _$jscoverage['db.js'][168] = 0;
  _$jscoverage['db.js'][169] = 0;
  _$jscoverage['db.js'][170] = 0;
  _$jscoverage['db.js'][171] = 0;
  _$jscoverage['db.js'][172] = 0;
  _$jscoverage['db.js'][173] = 0;
  _$jscoverage['db.js'][174] = 0;
  _$jscoverage['db.js'][177] = 0;
  _$jscoverage['db.js'][178] = 0;
  _$jscoverage['db.js'][184] = 0;
  _$jscoverage['db.js'][185] = 0;
  _$jscoverage['db.js'][186] = 0;
  _$jscoverage['db.js'][187] = 0;
  _$jscoverage['db.js'][188] = 0;
  _$jscoverage['db.js'][189] = 0;
  _$jscoverage['db.js'][190] = 0;
  _$jscoverage['db.js'][191] = 0;
  _$jscoverage['db.js'][192] = 0;
  _$jscoverage['db.js'][193] = 0;
}
_$jscoverage['db.js'].source = ["<span class=\"k\">var</span> mongo <span class=\"k\">=</span> require<span class=\"k\">(</span><span class=\"s\">'mongodb'</span><span class=\"k\">);</span>","","<span class=\"k\">var</span> server <span class=\"k\">=</span> <span class=\"k\">new</span> mongo<span class=\"k\">.</span>Server<span class=\"k\">(</span><span class=\"s\">'localhost'</span><span class=\"k\">,</span> <span class=\"s\">27017</span><span class=\"k\">);</span>","<span class=\"k\">var</span> db <span class=\"k\">=</span> <span class=\"k\">new</span> mongo<span class=\"k\">.</span>Db<span class=\"k\">(</span><span class=\"s\">'web'</span><span class=\"k\">,</span> server<span class=\"k\">);</span>","","<span class=\"k\">var</span> loginRepo <span class=\"k\">=</span> <span class=\"s\">\"projekt\"</span><span class=\"k\">;</span>","","<span class=\"k\">function</span> start<span class=\"k\">(</span>callback<span class=\"k\">)</span><span class=\"k\">{</span>    ","    db<span class=\"k\">.</span>open<span class=\"k\">(</span><span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span>db<span class=\"k\">)</span><span class=\"k\">{</span>","        <span class=\"k\">if</span><span class=\"k\">(!</span>err<span class=\"k\">)</span><span class=\"k\">{</span>","            console<span class=\"k\">.</span>log<span class=\"k\">(</span><span class=\"s\">\"Connected to DB\"</span><span class=\"k\">);</span>","            callback<span class=\"k\">(</span><span class=\"k\">true</span><span class=\"k\">);</span>","        <span class=\"k\">}</span>","        <span class=\"k\">else</span> <span class=\"k\">{</span>","            callback<span class=\"k\">(</span><span class=\"k\">false</span><span class=\"k\">);</span>","        <span class=\"k\">}</span>","    <span class=\"k\">}</span><span class=\"k\">);</span>","<span class=\"k\">}</span>","","<span class=\"k\">function</span> regUser<span class=\"k\">(</span>response<span class=\"k\">,</span> username<span class=\"k\">,</span> password<span class=\"k\">,</span> name<span class=\"k\">,</span> callback<span class=\"k\">)</span> <span class=\"k\">{</span>","    db<span class=\"k\">.</span>collection<span class=\"k\">(</span>loginRepo<span class=\"k\">,</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> collection<span class=\"k\">)</span> <span class=\"k\">{</span>","        collection<span class=\"k\">.</span>findOne<span class=\"k\">(</span><span class=\"k\">{</span><span class=\"s\">\"username\"</span><span class=\"k\">:</span>username<span class=\"k\">}</span><span class=\"k\">,</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> user<span class=\"k\">)</span><span class=\"k\">{</span>","            <span class=\"k\">if</span> <span class=\"k\">(</span>user <span class=\"k\">==</span> <span class=\"k\">null</span><span class=\"k\">)</span> <span class=\"k\">{</span>","                <span class=\"k\">var</span> newUser <span class=\"k\">=</span> <span class=\"k\">{</span><span class=\"s\">\"username\"</span> <span class=\"k\">:</span> username<span class=\"k\">,</span>","                               <span class=\"s\">\"password\"</span> <span class=\"k\">:</span> password<span class=\"k\">,</span>","                               <span class=\"s\">\"active\"</span><span class=\"k\">:</span><span class=\"k\">false</span><span class=\"k\">,</span>","                               <span class=\"s\">\"name\"</span><span class=\"k\">:</span> name<span class=\"k\">,</span>","                               <span class=\"s\">\"posts\"</span><span class=\"k\">:[],</span>","                               <span class=\"s\">\"friends\"</span><span class=\"k\">:</span> <span class=\"k\">[</span>username<span class=\"k\">]</span>","                              <span class=\"k\">}</span><span class=\"k\">;</span>","                collection<span class=\"k\">.</span>insert<span class=\"k\">(</span>newUser<span class=\"k\">,</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> result<span class=\"k\">)</span><span class=\"k\">{</span>","                    callback<span class=\"k\">(</span><span class=\"s\">\"Congratulations! Your account has been successfully registred.\"</span><span class=\"k\">);</span>","                <span class=\"k\">}</span><span class=\"k\">);</span>","            <span class=\"k\">}</span>","            <span class=\"k\">else</span> <span class=\"k\">{</span>","                callback<span class=\"k\">(</span><span class=\"s\">\"The username is already in use, please try another one!\"</span><span class=\"k\">);</span>","            <span class=\"k\">}</span>","        <span class=\"k\">}</span><span class=\"k\">);</span>","    <span class=\"k\">}</span><span class=\"k\">);</span>","                         ","<span class=\"k\">}</span>","","<span class=\"k\">function</span> userLogin<span class=\"k\">(</span>response<span class=\"k\">,</span> username<span class=\"k\">,</span> password<span class=\"k\">,</span> callback<span class=\"k\">)</span><span class=\"k\">{</span>","    db<span class=\"k\">.</span>collection<span class=\"k\">(</span>loginRepo<span class=\"k\">,</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> collection<span class=\"k\">)</span><span class=\"k\">{</span>","        <span class=\"k\">try</span> <span class=\"k\">{</span>","            collection<span class=\"k\">.</span>findOne<span class=\"k\">(</span><span class=\"k\">{</span><span class=\"s\">\"username\"</span><span class=\"k\">:</span>username<span class=\"k\">}</span><span class=\"k\">,</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> user<span class=\"k\">)</span><span class=\"k\">{</span>","                <span class=\"k\">if</span> <span class=\"k\">(</span>user <span class=\"k\">!=</span> <span class=\"k\">null</span> <span class=\"k\">&amp;&amp;</span> user<span class=\"k\">[</span><span class=\"s\">\"password\"</span><span class=\"k\">]</span> <span class=\"k\">==</span> password<span class=\"k\">)</span> <span class=\"k\">{</span>","                    collection<span class=\"k\">.</span>update<span class=\"k\">(</span><span class=\"k\">{</span><span class=\"s\">\"username\"</span><span class=\"k\">:</span>username<span class=\"k\">}</span><span class=\"k\">,</span><span class=\"k\">{</span>$set<span class=\"k\">:</span><span class=\"k\">{</span><span class=\"s\">\"active\"</span><span class=\"k\">:</span><span class=\"k\">true</span><span class=\"k\">}}</span><span class=\"k\">);</span>","                    callback<span class=\"k\">(</span><span class=\"s\">\"1\"</span><span class=\"k\">);</span>","                <span class=\"k\">}</span>","                <span class=\"k\">else</span> <span class=\"k\">{</span>","                    callback<span class=\"k\">(</span><span class=\"s\">\"0\"</span><span class=\"k\">);</span>","                <span class=\"k\">}</span>","            <span class=\"k\">}</span><span class=\"k\">);</span>","        <span class=\"k\">}</span>","        <span class=\"k\">catch</span><span class=\"k\">(</span>err<span class=\"k\">)</span> <span class=\"k\">{</span>","            callback<span class=\"k\">(</span><span class=\"s\">\"3\"</span><span class=\"k\">);</span>","        <span class=\"k\">}</span>","    <span class=\"k\">}</span><span class=\"k\">);</span>","<span class=\"k\">}</span>","","<span class=\"k\">function</span> userLogoff<span class=\"k\">(</span>response<span class=\"k\">,</span> username<span class=\"k\">,</span> callback<span class=\"k\">)</span> <span class=\"k\">{</span>","    db<span class=\"k\">.</span>collection<span class=\"k\">(</span>loginRepo<span class=\"k\">,</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> collection<span class=\"k\">)</span><span class=\"k\">{</span>","        <span class=\"k\">try</span> <span class=\"k\">{</span>","            collection<span class=\"k\">.</span>findOne<span class=\"k\">(</span><span class=\"k\">{</span><span class=\"s\">\"username\"</span><span class=\"k\">:</span>username<span class=\"k\">}</span><span class=\"k\">,</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> user<span class=\"k\">)</span><span class=\"k\">{</span>","                collection<span class=\"k\">.</span>update<span class=\"k\">(</span><span class=\"k\">{</span><span class=\"s\">\"username\"</span><span class=\"k\">:</span>username<span class=\"k\">}</span><span class=\"k\">,</span><span class=\"k\">{</span>$set<span class=\"k\">:</span><span class=\"k\">{</span><span class=\"s\">\"active\"</span><span class=\"k\">:</span><span class=\"k\">false</span><span class=\"k\">}}</span><span class=\"k\">);</span>","                callback<span class=\"k\">(</span><span class=\"s\">\"You logged off!\"</span><span class=\"k\">);</span>","            <span class=\"k\">}</span><span class=\"k\">);</span>","        <span class=\"k\">}</span>","        <span class=\"k\">catch</span><span class=\"k\">(</span>err<span class=\"k\">)</span> <span class=\"k\">{</span>","            callback<span class=\"k\">(</span><span class=\"s\">\"Database error!\"</span><span class=\"k\">);</span>","            ","        <span class=\"k\">}</span>","    <span class=\"k\">}</span><span class=\"k\">);</span>","<span class=\"k\">}</span>","","<span class=\"k\">function</span> addPost<span class=\"k\">(</span>response<span class=\"k\">,</span> src_user<span class=\"k\">,</span> target_user<span class=\"k\">,</span> text<span class=\"k\">,</span> callback<span class=\"k\">)</span><span class=\"k\">{</span>","    db<span class=\"k\">.</span>collection<span class=\"k\">(</span>loginRepo<span class=\"k\">,</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> collection<span class=\"k\">)</span> <span class=\"k\">{</span>","        collection<span class=\"k\">.</span>findOne<span class=\"k\">(</span><span class=\"k\">{</span><span class=\"s\">\"username\"</span><span class=\"k\">:</span>target_user<span class=\"k\">}</span><span class=\"k\">,</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> target_prof<span class=\"k\">)</span><span class=\"k\">{</span>","            <span class=\"k\">if</span><span class=\"k\">(</span>target_prof <span class=\"k\">!=</span> <span class=\"k\">null</span><span class=\"k\">)</span> <span class=\"k\">{</span>   ","                <span class=\"k\">if</span><span class=\"k\">(</span>target_prof<span class=\"k\">[</span><span class=\"s\">\"friends\"</span><span class=\"k\">].</span>indexOf<span class=\"k\">(</span>src_user<span class=\"k\">)</span> <span class=\"k\">!=</span> <span class=\"k\">-</span><span class=\"s\">1</span><span class=\"k\">)</span> <span class=\"k\">{</span>","                    <span class=\"k\">var</span> newPost <span class=\"k\">=</span> <span class=\"k\">{</span><span class=\"s\">\"post\"</span> <span class=\"k\">:</span> text<span class=\"k\">,</span> <span class=\"s\">\"user\"</span> <span class=\"k\">:</span> src_user<span class=\"k\">}</span><span class=\"k\">;</span>","                    console<span class=\"k\">.</span>log<span class=\"k\">(</span>text <span class=\"k\">+</span> src_user<span class=\"k\">);</span>","                    collection<span class=\"k\">.</span>update<span class=\"k\">(</span><span class=\"k\">{</span><span class=\"s\">\"username\"</span><span class=\"k\">:</span>target_user<span class=\"k\">}</span><span class=\"k\">,</span>","                                      <span class=\"k\">{</span>$push<span class=\"k\">:</span><span class=\"k\">{</span><span class=\"s\">\"posts\"</span><span class=\"k\">:</span> newPost<span class=\"k\">}}</span><span class=\"k\">,</span> <span class=\"k\">function</span> <span class=\"k\">(</span>err<span class=\"k\">)</span> <span class=\"k\">{</span>","                                          console<span class=\"k\">.</span>log<span class=\"k\">(</span>err<span class=\"k\">);</span>","                                      <span class=\"k\">}</span><span class=\"k\">);</span>","                    callback<span class=\"k\">(</span><span class=\"s\">\"Post sent to \"</span> <span class=\"k\">+</span> target_user <span class=\"k\">+</span> <span class=\"s\">\"'s profile!\"</span><span class=\"k\">);</span>","                <span class=\"k\">}</span>","                <span class=\"k\">else</span> <span class=\"k\">{</span>","                    callback<span class=\"k\">(</span><span class=\"s\">\"Cant post on \"</span> <span class=\"k\">+</span>target_user <span class=\"k\">+</span> <span class=\"s\">\"'s profile yet. You need to be friends first!\"</span><span class=\"k\">);</span>","                <span class=\"k\">}</span>","            <span class=\"k\">}</span>","            <span class=\"k\">else</span> <span class=\"k\">{</span>","                callback<span class=\"k\">(</span>target_user <span class=\"k\">+</span> <span class=\"s\">\" is not a registred user!\"</span><span class=\"k\">);</span>","            <span class=\"k\">}</span>","        <span class=\"k\">}</span><span class=\"k\">);</span>","    <span class=\"k\">}</span><span class=\"k\">);</span>","<span class=\"k\">}</span>","","<span class=\"k\">function</span> getProfile<span class=\"k\">(</span>response<span class=\"k\">,</span> userprofile<span class=\"k\">,</span> username<span class=\"k\">,</span> callback<span class=\"k\">)</span><span class=\"k\">{</span>","    db<span class=\"k\">.</span>collection<span class=\"k\">(</span>loginRepo<span class=\"k\">,</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> collection<span class=\"k\">)</span><span class=\"k\">{</span>       ","        collection<span class=\"k\">.</span>findOne<span class=\"k\">(</span><span class=\"k\">{</span><span class=\"s\">\"username\"</span><span class=\"k\">:</span>username<span class=\"k\">}</span><span class=\"k\">,</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> user<span class=\"k\">)</span><span class=\"k\">{</span>","            <span class=\"k\">var</span> friends <span class=\"k\">=</span> <span class=\"k\">false</span><span class=\"k\">;</span>","            <span class=\"k\">if</span><span class=\"k\">(</span>userprofile <span class=\"k\">!=</span> username<span class=\"k\">)</span> <span class=\"k\">{</span>","                <span class=\"k\">for</span> <span class=\"k\">(</span>index <span class=\"k\">in</span> user<span class=\"k\">[</span><span class=\"s\">\"friends\"</span><span class=\"k\">])</span> <span class=\"k\">{</span>","                    <span class=\"k\">if</span><span class=\"k\">(</span>userprofile <span class=\"k\">==</span> user<span class=\"k\">[</span><span class=\"s\">\"friends\"</span><span class=\"k\">][</span>index<span class=\"k\">])</span> <span class=\"k\">{</span>","                        friends <span class=\"k\">=</span> <span class=\"k\">true</span><span class=\"k\">;</span>","                        <span class=\"k\">break</span><span class=\"k\">;</span>","                    <span class=\"k\">}</span>","                <span class=\"k\">}</span>","            <span class=\"k\">}</span>","            callback<span class=\"k\">(</span><span class=\"k\">{</span><span class=\"s\">\"name\"</span><span class=\"k\">:</span> user<span class=\"k\">[</span><span class=\"s\">\"name\"</span><span class=\"k\">],</span> <span class=\"s\">\"username\"</span><span class=\"k\">:</span>user<span class=\"k\">[</span><span class=\"s\">\"username\"</span><span class=\"k\">],</span> <span class=\"s\">\"posts\"</span><span class=\"k\">:</span> user<span class=\"k\">[</span><span class=\"s\">\"posts\"</span><span class=\"k\">],</span> <span class=\"s\">\"friends\"</span><span class=\"k\">:</span> friends<span class=\"k\">}</span><span class=\"k\">);</span>","        <span class=\"k\">}</span><span class=\"k\">);</span>","    <span class=\"k\">}</span><span class=\"k\">);</span>","<span class=\"k\">}</span>","","<span class=\"k\">function</span> addFriend<span class=\"k\">(</span>response<span class=\"k\">,</span> src_user<span class=\"k\">,</span> target_user<span class=\"k\">,</span> callback<span class=\"k\">)</span><span class=\"k\">{</span>","    db<span class=\"k\">.</span>collection<span class=\"k\">(</span>loginRepo<span class=\"k\">,</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> collection<span class=\"k\">)</span><span class=\"k\">{</span>","        collection<span class=\"k\">.</span>update<span class=\"k\">(</span><span class=\"k\">{</span><span class=\"s\">\"username\"</span><span class=\"k\">:</span>src_user<span class=\"k\">}</span><span class=\"k\">,</span>","                          <span class=\"k\">{</span>$push<span class=\"k\">:</span><span class=\"k\">{</span><span class=\"s\">\"friends\"</span><span class=\"k\">:</span> target_user<span class=\"k\">}}</span><span class=\"k\">);</span>","        collection<span class=\"k\">.</span>update<span class=\"k\">(</span><span class=\"k\">{</span><span class=\"s\">\"username\"</span><span class=\"k\">:</span>target_user<span class=\"k\">}</span><span class=\"k\">,</span>","                          <span class=\"k\">{</span>$push<span class=\"k\">:</span><span class=\"k\">{</span><span class=\"s\">\"friends\"</span><span class=\"k\">:</span> src_user<span class=\"k\">}}</span><span class=\"k\">);</span>","        ","        callback<span class=\"k\">(</span>target_user <span class=\"k\">+</span> <span class=\"s\">\" added to your friends!\"</span><span class=\"k\">);</span>","    <span class=\"k\">}</span><span class=\"k\">);</span>","<span class=\"k\">}</span>","","<span class=\"k\">function</span> getFriends<span class=\"k\">(</span>response<span class=\"k\">,</span> username<span class=\"k\">,</span> callback<span class=\"k\">)</span><span class=\"k\">{</span>","    <span class=\"k\">var</span> friends <span class=\"k\">=</span> <span class=\"k\">new</span> Array<span class=\"k\">();</span>","    db<span class=\"k\">.</span>collection<span class=\"k\">(</span>loginRepo<span class=\"k\">,</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> collection<span class=\"k\">)</span><span class=\"k\">{</span>","        collection<span class=\"k\">.</span>findOne<span class=\"k\">(</span><span class=\"k\">{</span><span class=\"s\">\"username\"</span><span class=\"k\">:</span>username<span class=\"k\">}</span><span class=\"k\">,</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> user<span class=\"k\">)</span><span class=\"k\">{</span>","            <span class=\"k\">for</span> <span class=\"k\">(</span>index <span class=\"k\">in</span> user<span class=\"k\">[</span><span class=\"s\">\"friends\"</span><span class=\"k\">])</span> <span class=\"k\">{</span>","                collection<span class=\"k\">.</span>findOne<span class=\"k\">(</span><span class=\"k\">{</span><span class=\"s\">\"username\"</span><span class=\"k\">:</span> user<span class=\"k\">[</span><span class=\"s\">\"friends\"</span><span class=\"k\">][</span>index<span class=\"k\">]</span><span class=\"k\">}</span><span class=\"k\">,</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> friend<span class=\"k\">)</span> <span class=\"k\">{</span>","                    friends<span class=\"k\">.</span>push<span class=\"k\">(</span><span class=\"k\">{</span><span class=\"s\">\"name\"</span><span class=\"k\">:</span> friend<span class=\"k\">[</span><span class=\"s\">\"name\"</span><span class=\"k\">],</span> <span class=\"s\">\"user\"</span><span class=\"k\">:</span> friend<span class=\"k\">[</span><span class=\"s\">\"username\"</span><span class=\"k\">]</span><span class=\"k\">}</span><span class=\"k\">);</span>","                    <span class=\"k\">if</span> <span class=\"k\">(</span>user<span class=\"k\">[</span><span class=\"s\">\"friends\"</span><span class=\"k\">].</span>length <span class=\"k\">==</span> friends<span class=\"k\">.</span>length<span class=\"k\">)</span> <span class=\"k\">{</span>","                        callback<span class=\"k\">(</span>friends<span class=\"k\">);</span>","                    <span class=\"k\">}</span>","                <span class=\"k\">}</span><span class=\"k\">);</span>","            <span class=\"k\">}</span>","        <span class=\"k\">}</span><span class=\"k\">);</span>","    <span class=\"k\">}</span><span class=\"k\">);</span>","<span class=\"k\">}</span>","","<span class=\"k\">function</span> getOnlineFriends<span class=\"k\">(</span>response<span class=\"k\">,</span> username<span class=\"k\">,</span> callback<span class=\"k\">)</span><span class=\"k\">{</span>","    <span class=\"k\">var</span> onlineFriends <span class=\"k\">=</span> <span class=\"k\">new</span> Array<span class=\"k\">();</span>","    db<span class=\"k\">.</span>collection<span class=\"k\">(</span>loginRepo<span class=\"k\">,</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> collection<span class=\"k\">)</span><span class=\"k\">{</span>","        collection<span class=\"k\">.</span>findOne<span class=\"k\">(</span><span class=\"k\">{</span><span class=\"s\">\"username\"</span><span class=\"k\">:</span>username<span class=\"k\">}</span><span class=\"k\">,</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> user<span class=\"k\">)</span><span class=\"k\">{</span>","            console<span class=\"k\">.</span>log<span class=\"k\">(</span>user<span class=\"k\">[</span><span class=\"s\">\"friends\"</span><span class=\"k\">]);</span>","            <span class=\"k\">for</span> <span class=\"k\">(</span>index <span class=\"k\">in</span> user<span class=\"k\">[</span><span class=\"s\">\"friends\"</span><span class=\"k\">])</span> <span class=\"k\">{</span>","                console<span class=\"k\">.</span>log<span class=\"k\">(</span><span class=\"s\">\"find friend \"</span> <span class=\"k\">+</span> user<span class=\"k\">[</span><span class=\"s\">\"friends\"</span><span class=\"k\">][</span>index<span class=\"k\">]);</span>","                collection<span class=\"k\">.</span>findOne<span class=\"k\">(</span><span class=\"k\">{</span><span class=\"s\">\"username\"</span><span class=\"k\">:</span> user<span class=\"k\">[</span><span class=\"s\">\"friends\"</span><span class=\"k\">][</span>index<span class=\"k\">]</span><span class=\"k\">}</span><span class=\"k\">,</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> friend<span class=\"k\">)</span> <span class=\"k\">{</span>","                    console<span class=\"k\">.</span>log<span class=\"k\">(</span><span class=\"s\">\"friend:\"</span> <span class=\"k\">+</span> friend<span class=\"k\">);</span>","                    <span class=\"k\">if</span> <span class=\"k\">(</span>friend<span class=\"k\">[</span><span class=\"s\">\"active\"</span><span class=\"k\">])</span> <span class=\"k\">{</span>","                        onlineFriends<span class=\"k\">.</span>push<span class=\"k\">(</span><span class=\"k\">{</span><span class=\"s\">\"name\"</span><span class=\"k\">:</span> friend<span class=\"k\">[</span><span class=\"s\">\"name\"</span><span class=\"k\">],</span> <span class=\"s\">\"user\"</span><span class=\"k\">:</span> friend<span class=\"k\">[</span><span class=\"s\">\"username\"</span><span class=\"k\">]</span><span class=\"k\">}</span><span class=\"k\">);</span>","                    <span class=\"k\">}</span>","                    <span class=\"k\">if</span> <span class=\"k\">(</span>user<span class=\"k\">[</span><span class=\"s\">\"friends\"</span><span class=\"k\">].</span>length <span class=\"k\">==</span> index <span class=\"k\">+</span> <span class=\"s\">1</span><span class=\"k\">)</span> <span class=\"k\">{</span>","                        callback<span class=\"k\">(</span>onlineFriends<span class=\"k\">);</span>","                    <span class=\"k\">}</span>","                <span class=\"k\">}</span><span class=\"k\">);</span>","            <span class=\"k\">}</span>","        <span class=\"k\">}</span><span class=\"k\">);</span>","    <span class=\"k\">}</span><span class=\"k\">);</span>","<span class=\"k\">}</span>","","<span class=\"k\">function</span> searchUser<span class=\"k\">(</span>response<span class=\"k\">,</span> query<span class=\"k\">,</span> callback<span class=\"k\">)</span><span class=\"k\">{</span>","    db<span class=\"k\">.</span>collection<span class=\"k\">(</span>loginRepo<span class=\"k\">,</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> collection<span class=\"k\">)</span><span class=\"k\">{</span>","        <span class=\"k\">var</span> regexp <span class=\"k\">=</span> <span class=\"s\">\"(?i).*(\"</span> <span class=\"k\">+</span> query <span class=\"k\">+</span> <span class=\"s\">\")+.*\"</span><span class=\"k\">;</span>","        console<span class=\"k\">.</span>log<span class=\"k\">(</span>query<span class=\"k\">);</span>","        collection<span class=\"k\">.</span>find<span class=\"k\">(</span><span class=\"k\">{</span><span class=\"s\">\"name\"</span><span class=\"k\">:</span> <span class=\"k\">{</span>$regex<span class=\"k\">:</span> regexp<span class=\"k\">}}</span><span class=\"k\">).</span>toArray<span class=\"k\">(</span> <span class=\"k\">function</span><span class=\"k\">(</span>err<span class=\"k\">,</span> resultProfiles<span class=\"k\">)</span><span class=\"k\">{</span>","            console<span class=\"k\">.</span>log<span class=\"k\">(</span>resultProfiles<span class=\"k\">);</span>","            <span class=\"k\">var</span> result <span class=\"k\">=</span> <span class=\"k\">new</span> Array<span class=\"k\">();</span>","            <span class=\"k\">for</span> <span class=\"k\">(</span>index <span class=\"k\">in</span> resultProfiles<span class=\"k\">)</span> <span class=\"k\">{</span>","                result<span class=\"k\">[</span>index<span class=\"k\">]</span> <span class=\"k\">=</span> <span class=\"k\">{</span><span class=\"s\">\"user\"</span><span class=\"k\">:</span> resultProfiles<span class=\"k\">[</span>index<span class=\"k\">][</span><span class=\"s\">\"username\"</span><span class=\"k\">],</span>","                                 <span class=\"s\">\"name\"</span><span class=\"k\">:</span> resultProfiles<span class=\"k\">[</span>index<span class=\"k\">][</span><span class=\"s\">\"name\"</span><span class=\"k\">]</span><span class=\"k\">}</span><span class=\"k\">;</span>","            <span class=\"k\">}</span>","            console<span class=\"k\">.</span>log<span class=\"k\">(</span>result<span class=\"k\">);</span>","            callback<span class=\"k\">(</span>result<span class=\"k\">);</span>","        <span class=\"k\">}</span><span class=\"k\">);</span>","    <span class=\"k\">}</span><span class=\"k\">);</span>","<span class=\"k\">}</span>","","","exports<span class=\"k\">.</span>start <span class=\"k\">=</span> start<span class=\"k\">;</span>","exports<span class=\"k\">.</span>regUser <span class=\"k\">=</span> regUser<span class=\"k\">;</span>","exports<span class=\"k\">.</span>userLogin <span class=\"k\">=</span> userLogin<span class=\"k\">;</span>","exports<span class=\"k\">.</span>userLogoff <span class=\"k\">=</span> userLogoff<span class=\"k\">;</span>","exports<span class=\"k\">.</span>addPost <span class=\"k\">=</span> addPost<span class=\"k\">;</span>","exports<span class=\"k\">.</span>getProfile <span class=\"k\">=</span> getProfile<span class=\"k\">;</span>","exports<span class=\"k\">.</span>addFriend <span class=\"k\">=</span> addFriend<span class=\"k\">;</span>","exports<span class=\"k\">.</span>getFriends <span class=\"k\">=</span> getFriends<span class=\"k\">;</span>","exports<span class=\"k\">.</span>getOnlineFriends <span class=\"k\">=</span> getOnlineFriends<span class=\"k\">;</span>","exports<span class=\"k\">.</span>searchUser <span class=\"k\">=</span> searchUser<span class=\"k\">;</span>",""];
_$jscoverage['db.js'][1]++;
var mongo = require("mongodb");
_$jscoverage['db.js'][3]++;
var server = new (mongo.Server)("localhost", 27017);
_$jscoverage['db.js'][4]++;
var db = new (mongo.Db)("web", server);
_$jscoverage['db.js'][6]++;
var loginRepo = "projekt";
_$jscoverage['db.js'][8]++;
function start(callback) {
  _$jscoverage['db.js'][9]++;
  db.open((function (err, db) {
  _$jscoverage['db.js'][10]++;
  if ((! err)) {
    _$jscoverage['db.js'][11]++;
    console.log("Connected to DB");
    _$jscoverage['db.js'][12]++;
    callback(true);
  }
  else {
    _$jscoverage['db.js'][15]++;
    callback(false);
  }
}));
}
_$jscoverage['db.js'][20]++;
function regUser(response, username, password, name, callback) {
  _$jscoverage['db.js'][21]++;
  db.collection(loginRepo, (function (err, collection) {
  _$jscoverage['db.js'][22]++;
  collection.findOne({"username": username}, (function (err, user) {
  _$jscoverage['db.js'][23]++;
  if ((user == null)) {
    _$jscoverage['db.js'][24]++;
    var newUser = {"username": username, "password": password, "active": false, "name": name, "posts": [], "friends": [username]};
    _$jscoverage['db.js'][31]++;
    collection.insert(newUser, (function (err, result) {
  _$jscoverage['db.js'][32]++;
  callback("Congratulations! Your account has been successfully registred.");
}));
  }
  else {
    _$jscoverage['db.js'][36]++;
    callback("The username is already in use, please try another one!");
  }
}));
}));
}
_$jscoverage['db.js'][43]++;
function userLogin(response, username, password, callback) {
  _$jscoverage['db.js'][44]++;
  db.collection(loginRepo, (function (err, collection) {
  _$jscoverage['db.js'][45]++;
  try {
    _$jscoverage['db.js'][46]++;
    collection.findOne({"username": username}, (function (err, user) {
  _$jscoverage['db.js'][47]++;
  if (((user != null) && (user.password == password))) {
    _$jscoverage['db.js'][48]++;
    collection.update({"username": username}, {$set: {"active": true}});
    _$jscoverage['db.js'][49]++;
    callback("1");
  }
  else {
    _$jscoverage['db.js'][52]++;
    callback("0");
  }
}));
  }
  catch (err) {
    _$jscoverage['db.js'][57]++;
    callback("3");
  }
}));
}
_$jscoverage['db.js'][62]++;
function userLogoff(response, username, callback) {
  _$jscoverage['db.js'][63]++;
  db.collection(loginRepo, (function (err, collection) {
  _$jscoverage['db.js'][64]++;
  try {
    _$jscoverage['db.js'][65]++;
    collection.findOne({"username": username}, (function (err, user) {
  _$jscoverage['db.js'][66]++;
  collection.update({"username": username}, {$set: {"active": false}});
  _$jscoverage['db.js'][67]++;
  callback("You logged off!");
}));
  }
  catch (err) {
    _$jscoverage['db.js'][71]++;
    callback("Database error!");
  }
}));
}
_$jscoverage['db.js'][77]++;
function addPost(response, src_user, target_user, text, callback) {
  _$jscoverage['db.js'][78]++;
  db.collection(loginRepo, (function (err, collection) {
  _$jscoverage['db.js'][79]++;
  collection.findOne({"username": target_user}, (function (err, target_prof) {
  _$jscoverage['db.js'][80]++;
  if ((target_prof != null)) {
    _$jscoverage['db.js'][81]++;
    if ((target_prof.friends.indexOf(src_user) != -1)) {
      _$jscoverage['db.js'][82]++;
      var newPost = {"post": text, "user": src_user};
      _$jscoverage['db.js'][83]++;
      console.log((text + src_user));
      _$jscoverage['db.js'][84]++;
      collection.update({"username": target_user}, {$push: {"posts": newPost}}, (function (err) {
  _$jscoverage['db.js'][86]++;
  console.log(err);
}));
      _$jscoverage['db.js'][88]++;
      callback(("Post sent to " + target_user + "'s profile!"));
    }
    else {
      _$jscoverage['db.js'][91]++;
      callback(("Cant post on " + target_user + "'s profile yet. You need to be friends first!"));
    }
  }
  else {
    _$jscoverage['db.js'][95]++;
    callback((target_user + " is not a registred user!"));
  }
}));
}));
}
_$jscoverage['db.js'][101]++;
function getProfile(response, userprofile, username, callback) {
  _$jscoverage['db.js'][102]++;
  db.collection(loginRepo, (function (err, collection) {
  _$jscoverage['db.js'][103]++;
  collection.findOne({"username": username}, (function (err, user) {
  _$jscoverage['db.js'][104]++;
  var friends = false;
  _$jscoverage['db.js'][105]++;
  if ((userprofile != username)) {
    _$jscoverage['db.js'][106]++;
    for (index in user.friends) {
      _$jscoverage['db.js'][107]++;
      if ((userprofile == user.friends[index])) {
        _$jscoverage['db.js'][108]++;
        friends = true;
        _$jscoverage['db.js'][109]++;
        break;
      }
}
  }
  _$jscoverage['db.js'][113]++;
  callback({"name": user.name, "username": user.username, "posts": user.posts, "friends": friends});
}));
}));
}
_$jscoverage['db.js'][118]++;
function addFriend(response, src_user, target_user, callback) {
  _$jscoverage['db.js'][119]++;
  db.collection(loginRepo, (function (err, collection) {
  _$jscoverage['db.js'][120]++;
  collection.update({"username": src_user}, {$push: {"friends": target_user}});
  _$jscoverage['db.js'][122]++;
  collection.update({"username": target_user}, {$push: {"friends": src_user}});
  _$jscoverage['db.js'][125]++;
  callback((target_user + " added to your friends!"));
}));
}
_$jscoverage['db.js'][129]++;
function getFriends(response, username, callback) {
  _$jscoverage['db.js'][130]++;
  var friends = new Array();
  _$jscoverage['db.js'][131]++;
  db.collection(loginRepo, (function (err, collection) {
  _$jscoverage['db.js'][132]++;
  collection.findOne({"username": username}, (function (err, user) {
  _$jscoverage['db.js'][133]++;
  for (index in user.friends) {
    _$jscoverage['db.js'][134]++;
    collection.findOne({"username": user.friends[index]}, (function (err, friend) {
  _$jscoverage['db.js'][135]++;
  friends.push({"name": friend.name, "user": friend.username});
  _$jscoverage['db.js'][136]++;
  if ((user.friends.length == friends.length)) {
    _$jscoverage['db.js'][137]++;
    callback(friends);
  }
}));
}
}));
}));
}
_$jscoverage['db.js'][145]++;
function getOnlineFriends(response, username, callback) {
  _$jscoverage['db.js'][146]++;
  var onlineFriends = new Array();
  _$jscoverage['db.js'][147]++;
  db.collection(loginRepo, (function (err, collection) {
  _$jscoverage['db.js'][148]++;
  collection.findOne({"username": username}, (function (err, user) {
  _$jscoverage['db.js'][149]++;
  console.log(user.friends);
  _$jscoverage['db.js'][150]++;
  for (index in user.friends) {
    _$jscoverage['db.js'][151]++;
    console.log(("find friend " + user.friends[index]));
    _$jscoverage['db.js'][152]++;
    collection.findOne({"username": user.friends[index]}, (function (err, friend) {
  _$jscoverage['db.js'][153]++;
  console.log(("friend:" + friend));
  _$jscoverage['db.js'][154]++;
  if (friend.active) {
    _$jscoverage['db.js'][155]++;
    onlineFriends.push({"name": friend.name, "user": friend.username});
  }
  _$jscoverage['db.js'][157]++;
  if ((user.friends.length == (index + 1))) {
    _$jscoverage['db.js'][158]++;
    callback(onlineFriends);
  }
}));
}
}));
}));
}
_$jscoverage['db.js'][166]++;
function searchUser(response, query, callback) {
  _$jscoverage['db.js'][167]++;
  db.collection(loginRepo, (function (err, collection) {
  _$jscoverage['db.js'][168]++;
  var regexp = ("(?i).*(" + query + ")+.*");
  _$jscoverage['db.js'][169]++;
  console.log(query);
  _$jscoverage['db.js'][170]++;
  collection.find({"name": {$regex: regexp}}).toArray((function (err, resultProfiles) {
  _$jscoverage['db.js'][171]++;
  console.log(resultProfiles);
  _$jscoverage['db.js'][172]++;
  var result = new Array();
  _$jscoverage['db.js'][173]++;
  for (index in resultProfiles) {
    _$jscoverage['db.js'][174]++;
    result[index] = {"user": resultProfiles[index].username, "name": resultProfiles[index].name};
}
  _$jscoverage['db.js'][177]++;
  console.log(result);
  _$jscoverage['db.js'][178]++;
  callback(result);
}));
}));
}
_$jscoverage['db.js'][184]++;
exports.start = start;
_$jscoverage['db.js'][185]++;
exports.regUser = regUser;
_$jscoverage['db.js'][186]++;
exports.userLogin = userLogin;
_$jscoverage['db.js'][187]++;
exports.userLogoff = userLogoff;
_$jscoverage['db.js'][188]++;
exports.addPost = addPost;
_$jscoverage['db.js'][189]++;
exports.getProfile = getProfile;
_$jscoverage['db.js'][190]++;
exports.addFriend = addFriend;
_$jscoverage['db.js'][191]++;
exports.getFriends = getFriends;
_$jscoverage['db.js'][192]++;
exports.getOnlineFriends = getOnlineFriends;
_$jscoverage['db.js'][193]++;
exports.searchUser = searchUser;
